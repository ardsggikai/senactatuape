#Autor: Allan Richard De Souza Gomes
#Data de criação: 26/05/2022
#Data de atualização: 29/05/2022
#Versão: 0.03

#Etapa 1: atualização do sistema
#Antes de realizar qualquer instalação no Linux, você deve atualizar os pacotes do sistema.
#Execute o seguinte comando para atualizar o Ubuntu 22.04|20.04|18.04:

sudo apt update && sudo apt upgrade -y

#Passo 2: Instale o Vsftpd no Ubuntu 22.04|20.04|18.04
#Após a atualização do sistema, execute o seguinte comando para instalar o Vsftpd:

grupo2@wsgrupo2:~$ sudo apt install vsftpd
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
Os NOVOS pacotes a seguir serão instalados:
  vsftpd
0 pacotes atualizados, 1 pacotes novos instalados, 0 a serem removidos e 0 não atualizados.
É preciso baixar 123 kB de arquivos.
Depois desta operação, 326 kB adicionais de espaço em disco serão usados.
Obter:1 http://us.archive.ubuntu.com/ubuntu jammy/main amd64 vsftpd amd64 3.0.5-0ubuntu1 [123 kB]
Baixados 123 kB em 7s (17,6 kB/s)
Pré-configurando pacotes ...
A seleccionar pacote anteriormente não seleccionado vsftpd.
(Lendo banco de dados ... 75644 ficheiros e directórios actualmente instalados.)
A preparar para desempacotar .../vsftpd_3.0.5-0ubuntu1_amd64.deb ...
A descompactar vsftpd (3.0.5-0ubuntu1) ...
Configurando vsftpd (3.0.5-0ubuntu1) ...
Created symlink /etc/systemd/system/multi-user.target.wants/vsftpd.service → /lib/systemd/system/vsftpd.service.
A processar 'triggers' para man-db (2.10.2-1) ...
Scanning processes...
Scanning linux images...

Running kernel seems to be up-to-date.

No services need to be restarted.

No containers need to be restarted.

No user sessions are running outdated binaries.

No VM guests are running outdated hypervisor (qemu) binaries on this host.

#Etapa 3: criar usuário e diretório de FTP
#Agora é a hora de criar um usuário que será utilizado para se conectar ao servidor FTP.

sudo adduser ftpuser

Adding user `ftpuser' ...
Adding new group `ftpuser' (1001) ...
Adding new user `ftpuser' (1001) with group `ftpuser' ...
Creating home directory `/home/ftpuser' ...
Copying files from `/etc/skel' ...
New password:
Retype new password:
passwd: password updated successfully
Changing the user information for ftpuser
Enter the new value, or press ENTER for the default
        Full Name []:
        Room Number []:
        Work Phone []:
        Home Phone []:
        Other []:
Is the information correct? [Y/n] y

#Agora, crie um diretório FTP e atribua as permissões e propriedade apropriadas.

sudo mkdir -p /home/ftpuser/ftpdir

sudo chmod -R 750 /home/ftpuser/ftpdir

sudo chown ftpuser: /home/ftpuser/ftpdir

#Para permitir o acesso do usuário ao servidor vsftpd, adicione o usuário FTP ao arquivo /etc/vsftpd.user_list.
sudo bash -c 'echo ftpuser >> /etc/vsftpd.user_list'

#Etapa 4: configurar o servidor FTP Vsftpd
#Para editar o arquivo de configuração, vá para /etc/vsftpd.conf.

sudo vim /etc/vsftpd.conf

#Permitir o acesso remoto de usuários locais e bloquear usuários anônimos. Se alguma linha estiver faltando, #adicione-a.

anonymous_enable=NO
local_enable=YES

#Permitir que o usuário faça qualquer operação de FTP, incluindo download, upload, exclusão e adição de arquivos 

#descomentando a linha write_enable=YES.

write_enable=YES (essa linha vai estar comitada #)
Permitir que apenas o diretório inicial do usuário seja acessado por linha de descomentário chroot_local_user=YES.

chroot_local_user=YES

vai ficar assim 
# daemon started from an initscript.
listen=NO
#
# This directive enables listening on IPv6 sockets. By default, listening
# on the IPv6 "any" address (::) will accept connections from both IPv6
# and IPv4 clients. It is not necessary to listen on *both* IPv4 and IPv6
# sockets. If you want that (perhaps because you want to listen on specific
# addresses) then you must run two copies of vsftpd with two configuration
# files.
listen_ipv6=NO
#
# Allow anonymous FTP? (Disabled by default).
anonymous_enable=NO
#
# Uncomment this to allow local users to log in.
local_enable=YES
#
# Uncomment this to enable any form of FTP write command.
write_enable=YES
#
chroot_local_user=YES
# Default umask for local users is 077. You may wish to change this to 022,
# if your users expect that (022 is used by most other ftpd's)
#local_umask=022

#O Vsftpd opera no modo ativo por padrão. 
------------------------------------------------------------------------------------------------------------
#Defina os intervalos de porta mínimo e máximo para usar o modo passivo. #(opcional) 

#pasv_min_port=30000
#pasv_max_port=31000

#O Vsftpd pode ser configurado para permitir que apenas pessoas especificadas façam login. (opcional)

#userlist_enable=YES
#userlist_file=/etc/vsftpd.user_list
#userlist_deny=NO

O arquivo deve ser salvo e fechado. Para permitir que as alterações sejam sincronizadas, reinicie os serviços vsftpd.
------------------------------------------------------------------------------------------------------------

Esq Shift+: 
x enter

sudo systemctl restart vsftpd

-------------------------------------------------------------------------------------------------------------------
#observação caso o seu ocorra o erro error 500 oops vsftpd refusing to run with writable root inside chroot
#Link https://www.liquidweb.com/kb/error-500-oops-vsftpd-refusing-to-run-with-writable-root-inside-chroot-solved/
#caso precise ver um video https://www.youtube.com/watch?v=9TJJykahhSU
-------------------------------------------------------------------------------------------------------------------

#Execute o comando ftp seguido pelo IP do seu servidor para testar sua conexão ftp, conforme mostrado abaixo. #Preencha o usuário FTP e a senha que você configurou antes.

 ftp 172.16.2.20
 ftp 192.168.0.81
Connected to 172.16.2.20.
220 (vsFTPd 3.0.5)
Name (172.16.2.20:grupo2): ftpuser
331 Please specify the password.
Password:
230 Login successful.
Remote system type is UNIX.
Using binary mode to transfer files.
ftp> ls
229 Entering Extended Passive Mode (|||37217|)
150 Here comes the directory listing.
drwxr-x---    2 1001     1001         4096 May 29 06:23 ftpdir
226 Directory send OK.
ftp> exit
221 Goodbye.

#Etapa 5: configuração do firewall Vsftpd
#Agora, permita tráfego FTP na porta 20, dados FTP na porta 21 e conexão passiva com vsftpd nas portas 30000-31000.

sudo ufw allow 20:21/tcp

sudo ufw allow 30000:31000/tcp

Recarregue o firewall para entrar em vigor .

grupo2@wsgrupo2:~$ sudo ufw disable && sudo ufw enable

Firewall stopped and disabled on system startup
Command may disrupt existing ssh connections. Proceed with operation (y|n)? y
Firewall is active and enabled on system startup 


#Etapa 6: teste o Vsftpd com o cliente FTP FileZilla
#Um cliente FTP conhecido como FileZilla é necessário para se conectar ao servidor FTP (vsftpd). Para instalar o #FileZilla no Ubuntu 20.04|18.04, execute o comando abaixo.

sudo apt install filezilla

#Agora você pode se conectar ao vsftpd usando seu cliente FTP. Digite respeitosamente o IP do servidor vsftpd, nome #de usuário e senha. Para iniciar a conexão, clique no botão Quickconnect no lado esquerdo.
